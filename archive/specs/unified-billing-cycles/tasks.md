# Implementation Plan: Unified Billing Cycles

## Overview

This implementation plan covers the Unified Billing Cycles feature, which consolidates billing cycle functionality by merging the "Billing Cycle History" section and "Statements" tab into a unified "Billing Cycles" tab with auto-generation, transaction counts, and trend indicators. The implementation builds on the existing credit-card-billing-cycle-history infrastructure.

## Tasks

- [x] 1. Code Cleanup and Consolidation
  - [x] 1.1 Audit and consolidate statement balance calculation utilities
    - Review `statementBalanceService.calculateStatementBalance` (uses billing_cycle_day)
    - Review `paymentMethodService.calculateStatementBalance` (uses billing_cycle_start/end - legacy)
    - Consolidate to use `statementBalanceService` as the single source of truth
    - Update `paymentMethodService` to delegate to `statementBalanceService` or remove redundant method
    - Ensure all callers use the consolidated approach
    - _Requirements: 9.3 (backward compatibility)_
  
  - [x] 1.2 Consolidate cycle date calculation helpers
    - Identify duplicate `calculatePreviousCycleDates` implementations in test files
    - Create shared test utility if needed, or ensure tests use `statementBalanceService.calculatePreviousCycleDates`
    - _Requirements: 2.2_

- [x] 2. Backend Service Enhancements
  - [x] 2.1 Add auto-generation methods to BillingCycleHistoryService
    - Add `getMissingCyclePeriods(paymentMethodId, billingCycleDay, referenceDate, monthsBack)` method
    - Add `autoGenerateBillingCycles(paymentMethodId, billingCycleDay, referenceDate)` method
    - Auto-generate cycles with actual_statement_balance = 0
    - Calculate and store calculated_statement_balance using StatementBalanceService
    - Respect 12-month limit from reference date
    - Skip periods that already have records (idempotence)
    - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6_
  
  - [x] 2.2 Write property tests for auto-generation
    - Create `backend/services/billingCycleHistoryService.autoGeneration.pbt.test.js`
    - **Property 1: Auto-Generation Date Calculation**
    - **Property 2: Auto-Generated Cycles Have Zero Actual Balance**
    - **Property 3: Auto-Generation Idempotence**
    - **Property 4: Auto-Generation 12-Month Limit**
    - **Property 10: Auto-Generation Preserves Existing Records**
    - **Property 11: No Auto-Generation Without Billing Cycle Day**
    - **Validates: Requirements 2.2, 2.3, 2.5, 2.6, 7.2, 9.1, 9.2**

  - [x] 2.3 Add effective balance and trend calculation methods
    - Add `calculateEffectiveBalance(cycle)` method returning { effectiveBalance, balanceType }
    - Add `calculateTrendIndicator(currentEffectiveBalance, previousEffectiveBalance)` method
    - Implement $1 tolerance for "same" trend type
    - Return null trend indicator when no previous cycle exists
    - _Requirements: 4.1, 4.2, 5.1, 5.2, 5.3, 5.4, 5.5, 5.6_

  - [x] 2.4 Write property tests for effective balance and trend
    - Create `backend/services/billingCycleHistoryService.effective.pbt.test.js`
    - **Property 6: Effective Balance Calculation**
    - **Validates: Requirements 4.1, 4.2**
    - Create `backend/services/billingCycleHistoryService.trend.pbt.test.js`
    - **Property 7: Trend Indicator Calculation**
    - **Validates: Requirements 5.2, 5.3, 5.4, 5.6**

  - [x] 2.5 Add transaction count method
    - Add `getTransactionCount(paymentMethodId, cycleStartDate, cycleEndDate)` method
    - Count expenses where COALESCE(posted_date, date) falls within cycle period
    - _Requirements: 3.1, 3.2_

  - [x] 2.6 Write property test for transaction count
    - Create `backend/repositories/billingCycleRepository.transactionCount.pbt.test.js`
    - **Property 5: Transaction Count Accuracy**
    - **Validates: Requirements 3.2**

  - [x] 2.7 Add unified billing cycles method
    - Add `getUnifiedBillingCycles(paymentMethodId, options)` method
    - Accept options: limit (default 12), includeAutoGenerate (default true), referenceDate
    - Call autoGenerateBillingCycles if includeAutoGenerate is true
    - Enrich each cycle with effective_balance, balance_type, transaction_count, trend_indicator
    - Sort by cycle_end_date descending
    - _Requirements: 6.1, 8.2, 8.3_

- [x] 3. Checkpoint - Backend Service Complete
  - Ensure all service tests pass
  - Ask the user if questions arise

- [x] 4. Backend Controller and Routes
  - [x] 4.1 Add unified endpoint to BillingCycleController
    - Add `getUnifiedBillingCycles(req, res)` method
    - Parse query parameters: limit, include_auto_generate
    - Validate payment method ID
    - Return enriched billing cycles with autoGeneratedCount and totalCount
    - _Requirements: 8.1, 8.3, 8.4_

  - [x] 4.2 Add unified route
    - Add GET `/api/payment-methods/:id/billing-cycles/unified` route in `backend/routes/billingCycleRoutes.js`
    - _Requirements: 8.1_

  - [x] 4.3 Write controller tests for unified endpoint
    - Create `backend/controllers/billingCycleController.unified.test.js`
    - Test endpoint with valid parameters
    - Test query parameter validation
    - Test error responses
    - **Property 8: Billing Cycles Sorted Descending**
    - **Validates: Requirements 6.1, 8.1, 8.3, 8.4**

- [x] 5. Checkpoint - Backend API Complete
  - Ensure all backend tests pass
  - Test unified endpoint manually
  - Ask the user if questions arise

- [x] 6. Frontend API Integration
  - [x] 6.1 Add unified endpoint to frontend config
    - Add `PAYMENT_METHOD_BILLING_CYCLES_UNIFIED` to `frontend/src/config.js`
    - _Requirements: 8.1_

  - [x] 6.2 Add unified API function
    - Add `getUnifiedBillingCycles(paymentMethodId, options)` to `frontend/src/services/creditCardApi.js`
    - Accept options: limit, includeAutoGenerate
    - _Requirements: 8.1_

- [x] 7. Frontend Component Updates
  - [x] 7.1 Create UnifiedBillingCycleList component
    - Create `frontend/src/components/UnifiedBillingCycleList.jsx`
    - Create `frontend/src/components/UnifiedBillingCycleList.css`
    - Display cycle dates, effective balance, balance type indicator, transaction count, trend indicator
    - Show edit/delete buttons when actual_statement_balance > 0
    - Show "Enter Statement" button when actual_statement_balance = 0
    - Handle empty state and loading state
    - _Requirements: 4.3, 5.1, 5.2, 5.3, 5.4, 5.5, 6.1, 6.2, 6.3, 6.4, 6.5_

  - [x] 7.2 Write tests for UnifiedBillingCycleList
    - Create `frontend/src/components/UnifiedBillingCycleList.test.jsx`
    - Test trend indicator rendering (icons, colors, amounts)
    - Test balance type indicator display
    - Test transaction count display
    - Create `frontend/src/components/UnifiedBillingCycleList.actions.pbt.test.jsx`
    - **Property 9: Action Buttons Based on Actual Balance**
    - **Validates: Requirements 6.3, 6.4**

  - [x] 7.3 Update CreditCardDetailView for unified billing cycles
    - Rename "Statements" tab to "Billing Cycles" in `frontend/src/components/CreditCardDetailView.jsx`
    - Remove "Billing Cycle History" collapsible section from Overview tab
    - Keep "Current Billing Cycle" card in Overview tab unchanged
    - Replace BillingCycleHistoryList with UnifiedBillingCycleList in Billing Cycles tab
    - Use new getUnifiedBillingCycles API
    - Handle "Enter Statement" action to open form with pre-populated dates
    - _Requirements: 1.1, 1.2, 1.3, 1.4, 6.5, 7.1, 7.3, 10.1, 10.2, 10.3_

  - [x] 7.4 Write tests for CreditCardDetailView updates
    - Create `frontend/src/components/CreditCardDetailView.unified.test.jsx`
    - Test tab label is "Billing Cycles" not "Statements"
    - Test Overview tab does not contain "Billing Cycle History" section
    - Test Overview tab still contains "Current Billing Cycle" card
    - Test empty state when billing_cycle_day not configured
    - **Validates: Requirements 1.1, 1.3, 1.4, 7.1, 7.3, 10.1, 10.3**

- [x] 8. Checkpoint - Feature Complete
  - Ensure all tests pass (backend and frontend)
  - Verify full flow: view unified billing cycles with auto-generation
  - Verify trend indicators display correctly
  - Verify "Enter Statement" opens form with correct dates
  - Verify existing CRUD operations still work (backward compatibility)
  - Ask the user if questions arise

- [x] 9. Final Integration Testing
  - [x] 9.1 Test backward compatibility
    - Verify existing billing cycle records are preserved
    - Verify existing CRUD endpoints still work
    - Verify reminder system still uses actual_statement_balance when available
    - _Requirements: 9.1, 9.2, 9.3, 9.4_

## Notes

- All tasks are required for comprehensive coverage
- Each task references specific requirements for traceability
- Checkpoints ensure incremental validation
- Property tests validate universal correctness properties
- Unit tests validate specific examples and edge cases
- This feature builds on existing credit-card-billing-cycle-history infrastructure

