version: '3.8'

# Feature Branch Preview Environment
# Use this compose file to test feature branches in containers before merging to main
#
# Usage:
#   1. Switch to your feature branch: git checkout feature/my-feature
#   2. Deploy preview: .\scripts\deploy-feature-preview.ps1
#   3. Test at http://localhost:3001 (frontend) and http://localhost:2425 (backend API)
#   4. Stop preview: .\scripts\deploy-feature-preview.ps1 -Stop
#
# The preview container:
#   - Runs on different ports (3001/2425) to avoid conflicts with staging/production
#   - Uses a separate preview-data volume for isolated testing
#   - Tagged with branch name for easy identification
#   - Can run alongside staging and production containers

services:
  expense-tracker-preview:
    image: localhost:5000/expense-tracker:preview-${PREVIEW_BRANCH_TAG:-feature}
    container_name: expense-tracker-preview
    ports:
      - "3001:2424"  # Frontend accessible at http://localhost:3001
    volumes:
      - ./preview-data:/config
    environment:
      - LOG_LEVEL=debug
      - SERVICE_TZ=America/Toronto
      - NODE_ENV=production  # Must be production/staging for container frontend path
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:2424/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
