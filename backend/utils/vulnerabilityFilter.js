/**
 * Vulnerability Severity Filtering
 * 
 * Encapsulates the logic for determining whether a build should fail
 * based on npm audit vulnerability severity levels.
 * 
 * Used by CI pipeline to decide pass/fail for dependency scanning.
 */

const SEVERITY_LEVELS = ['info', 'low', 'moderate', 'high', 'critical'];

const FAIL_SEVERITIES = new Set(['high', 'critical']);
const WARN_SEVERITIES = new Set(['low', 'moderate']);

/**
 * Determines whether the build should fail based on vulnerability findings.
 * 
 * @param {Object} auditResult - Parsed npm audit result
 * @param {Object} auditResult.vulnerabilities - Map of vulnerability name to details
 * @returns {{ shouldFail: boolean, highCount: number, criticalCount: number, lowCount: number, moderateCount: number }}
 */
function evaluateAuditResult(auditResult) {
  const counts = { info: 0, low: 0, moderate: 0, high: 0, critical: 0 };

  if (!auditResult || !auditResult.vulnerabilities) {
    return { shouldFail: false, ...counts };
  }

  for (const [, vuln] of Object.entries(auditResult.vulnerabilities)) {
    const severity = (vuln.severity || '').toLowerCase();
    if (counts.hasOwnProperty(severity)) {
      counts[severity]++;
    }
  }

  const shouldFail = counts.high > 0 || counts.critical > 0;

  return {
    shouldFail,
    highCount: counts.high,
    criticalCount: counts.critical,
    lowCount: counts.low,
    moderateCount: counts.moderate,
  };
}

/**
 * Checks if a given severity level should cause a build failure.
 * 
 * @param {string} severity - The vulnerability severity level
 * @returns {boolean} True if this severity should fail the build
 */
function isFailSeverity(severity) {
  return FAIL_SEVERITIES.has((severity || '').toLowerCase());
}

/**
 * Checks if a given severity level should produce a warning (but not fail).
 * 
 * @param {string} severity - The vulnerability severity level
 * @returns {boolean} True if this severity should warn but not fail
 */
function isWarnSeverity(severity) {
  return WARN_SEVERITIES.has((severity || '').toLowerCase());
}

module.exports = {
  evaluateAuditResult,
  isFailSeverity,
  isWarnSeverity,
  SEVERITY_LEVELS,
  FAIL_SEVERITIES,
  WARN_SEVERITIES,
};
